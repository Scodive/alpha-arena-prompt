<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Alpha Arena 实时交易播报</title>
  <style>
    :root {
      color-scheme: light;
      font-family: "Inter", "HarmonyOS Sans", "PingFang SC", "Microsoft YaHei", system-ui,
        -apple-system, sans-serif;
      background-color: #eef2f8;
      color: #0f1b31;
    }

    body {
      margin: 0;
      padding: 2.6rem 1rem 4rem;
      display: flex;
      justify-content: center;
      background: radial-gradient(
        140% 120% at 50% 0%,
        rgba(102, 153, 255, 0.18),
        rgba(238, 242, 248, 0.96) 68%
      );
    }

    main {
      width: min(1080px, 100%);
      display: flex;
      flex-direction: column;
      gap: 1.8rem;
    }

    header {
      display: flex;
      flex-direction: column;
      gap: 0.55rem;
    }

    header h1 {
      margin: 0;
      font-size: clamp(1.6rem, 2.4vw + 1rem, 2.7rem);
      font-weight: 700;
      letter-spacing: 0.05rem;
    }

    header p {
      margin: 0;
      color: #5a6787;
      font-size: 0.96rem;
    }

    .status-bar {
      display: flex;
      flex-wrap: wrap;
      gap: 0.75rem;
      font-size: 0.85rem;
      color: #5b6a7f;
    }

    .status-chip {
      padding: 0.36rem 0.85rem;
      border-radius: 999px;
      background: #ffffff;
      border: 1px solid #dbe4f4;
      display: inline-flex;
      align-items: center;
      gap: 0.45rem;
      box-shadow: 0 6px 18px rgba(111, 137, 212, 0.12);
    }

    .status-chip strong {
      font-weight: 600;
      color: #1f2f47;
    }

    .filters {
      display: flex;
      flex-wrap: wrap;
      gap: 1.2rem;
      align-items: center;
      background: rgba(255, 255, 255, 0.88);
      padding: 1rem 1.25rem;
      border-radius: 16px;
      border: 1px solid rgba(204, 214, 235, 0.9);
      box-shadow: 0 14px 32px rgba(41, 72, 159, 0.08);
    }

    .filter-group {
      display: flex;
      flex-direction: column;
      gap: 0.55rem;
      min-width: 200px;
    }

    .filter-group > span {
      font-size: 0.8rem;
      text-transform: uppercase;
      letter-spacing: 0.12rem;
      color: #6c7da0;
    }

    .filter-chips {
      display: flex;
      flex-wrap: wrap;
      gap: 0.55rem;
    }

    .filter-chip {
      border: 1px solid #ccd5ed;
      background: #f6f8fc;
      color: #22324d;
      padding: 0.36rem 0.9rem;
      border-radius: 999px;
      font-size: 0.83rem;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.16s ease-in-out;
    }

    .filter-chip:hover {
      border-color: #5b7ffa;
      color: #1b2d5a;
    }

    .filter-chip.active {
      background: linear-gradient(120deg, #4f7df8, #6dd5f7);
      border-color: transparent;
      color: #fff;
      box-shadow: 0 12px 26px rgba(79, 125, 248, 0.28);
    }

    .filter-actions {
      display: flex;
      align-items: center;
      gap: 0.8rem;
      margin-left: auto;
    }

    .filter-actions button {
      padding: 0.48rem 1.05rem;
      border-radius: 999px;
      border: none;
      background: #ecf2ff;
      color: #1f3d7a;
      font-weight: 600;
      cursor: pointer;
      transition: background 0.16s ease, color 0.16s ease;
    }

    .filter-actions button:hover {
      background: #dce6ff;
      color: #182b5d;
    }

    .filter-summary {
      display: flex;
      flex-wrap: wrap;
      gap: 1rem;
      font-size: 0.84rem;
      color: #5a6b87;
    }

    .feed {
      display: flex;
      flex-direction: column;
      gap: 1.2rem;
    }

    .trade-card {
      padding: 1.25rem 1.45rem 1.2rem;
      border-radius: 18px;
      background: rgba(255, 255, 255, 0.96);
      border: 1px solid rgba(210, 220, 240, 0.85);
      box-shadow: 0 18px 52px rgba(61, 92, 167, 0.16);
      display: flex;
      flex-direction: column;
      gap: 1rem;
    }

    .trade-header {
      display: flex;
      justify-content: space-between;
      align-items: baseline;
      gap: 0.8rem;
    }

    .trade-time {
      font-size: 0.95rem;
      font-weight: 600;
      color: #324467;
      letter-spacing: 0.05rem;
    }

    .trade-status {
      display: inline-flex;
      align-items: center;
      gap: 0.3rem;
      padding: 0.2rem 0.7rem;
      border-radius: 999px;
      font-size: 0.78rem;
      font-weight: 600;
      letter-spacing: 0.08rem;
      text-transform: uppercase;
      border: 1px solid transparent;
    }

    .trade-status.open {
      color: #155a35;
      background: rgba(31, 184, 120, 0.12);
      border-color: rgba(31, 184, 120, 0.4);
    }

    .trade-status.closed {
      color: #5d6791;
      background: rgba(152, 165, 213, 0.12);
      border-color: rgba(152, 165, 213, 0.35);
    }

    .trade-side {
      padding: 0.22rem 0.85rem;
      border-radius: 999px;
      font-size: 0.82rem;
      font-weight: 600;
      letter-spacing: 0.08rem;
      text-transform: uppercase;
      border: 1px solid transparent;
    }

    .trade-side.long {
      color: #10624b;
      background: rgba(24, 182, 138, 0.14);
      border-color: rgba(24, 182, 138, 0.4);
    }

    .trade-side.short {
      color: #a31f3f;
      background: rgba(246, 118, 146, 0.16);
      border-color: rgba(246, 118, 146, 0.42);
    }

    .trade-headline {
      font-size: 1.12rem;
      letter-spacing: 0.04rem;
      color: #142744;
      font-weight: 600;
    }

    .trade-meta {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
      gap: 1rem;
      font-size: 0.9rem;
    }

    .metric {
      display: flex;
      flex-direction: column;
      gap: 0.25rem;
      color: #586680;
    }

    .metric span {
      font-size: 0.72rem;
      letter-spacing: 0.1rem;
      text-transform: uppercase;
      color: #8897b4;
    }

    .metric strong {
      font-weight: 600;
      color: #111f35;
    }

    .empty-state,
    .error-state {
      text-align: center;
      padding: 2.4rem 1.2rem;
      border-radius: 18px;
      border: 1px dashed rgba(156, 176, 211, 0.6);
      background: rgba(255, 255, 255, 0.7);
      color: #667499;
      font-size: 0.95rem;
      line-height: 1.5;
    }

    footer {
      margin-top: 0.4rem;
      font-size: 0.78rem;
      color: #627091;
      text-align: right;
    }

    footer span {
      display: block;
      margin-top: 0.2rem;
      color: #8795b0;
    }

    @media (max-width: 720px) {
      body {
        padding: 2rem 0.9rem 3rem;
      }

      .filters {
        flex-direction: column;
        align-items: stretch;
      }

      .filter-actions {
        margin-left: 0;
        justify-content: flex-start;
      }

      .trade-meta {
        grid-template-columns: repeat(auto-fit, minmax(130px, 1fr));
      }
    }
  </style>
</head>
<body>
  <main>
    <header>
      <h1>Alpha Arena 实时交易播报</h1>
      <p>最新交易快讯，按时间倒序自动更新，适配 Vercel 部署。</p>
      <div class="status-bar">
        <div class="status-chip">
          <span>最后更新</span>
          <strong id="last-updated">—</strong>
        </div>
        <div class="status-chip">
          <span>刷新间隔</span>
          <strong>30 秒</strong>
        </div>
        <div class="status-chip">
          <span>状态</span>
          <strong id="status-text">准备中…</strong>
        </div>
      </div>
    </header>

    <section class="filters">
      <div class="filter-group">
        <span>模型</span>
        <div class="filter-chips" id="model-filters"></div>
      </div>
      <div class="filter-group">
        <span>币种</span>
        <div class="filter-chips" id="symbol-filters"></div>
      </div>
      <div class="filter-actions">
        <button id="filter-reset" type="button">重置筛选</button>
      </div>
    </section>

    <div class="filter-summary">
      <span id="model-summary"></span>
      <span id="symbol-summary"></span>
    </div>

    <section id="feed" class="feed" aria-live="polite"></section>
    <div id="empty-state" class="empty-state" hidden>暂无交易数据，请稍候…</div>
    <div id="error-state" class="error-state" hidden>获取交易数据失败，请稍后重试。</div>

    <footer>
      数据来源于 NOF1 公共 API · 页面每 30 秒自动刷新
      <span>进行中条目展示未实现盈亏，已结束条目展示已实现盈亏；数量同时保留符号与绝对值。</span>
    </footer>
  </main>

  <script>
    const API_URL = "/api/latest_trades";
    const POLL_INTERVAL = 30_000;

    const feedEl = document.getElementById("feed");
    const emptyStateEl = document.getElementById("empty-state");
    const errorStateEl = document.getElementById("error-state");
    const lastUpdatedEl = document.getElementById("last-updated");
    const statusTextEl = document.getElementById("status-text");
    const modelFiltersEl = document.getElementById("model-filters");
    const symbolFiltersEl = document.getElementById("symbol-filters");
    const resetFiltersBtn = document.getElementById("filter-reset");
    const modelSummaryEl = document.getElementById("model-summary");
    const symbolSummaryEl = document.getElementById("symbol-summary");

const state = {
  trades: [],
  filters: {
    model: "all",
    symbol: "all",
  },
  availableModels: [],
  availableSymbols: [],
};

    const timeFormatter = new Intl.DateTimeFormat(undefined, {
      hour: "2-digit",
      minute: "2-digit",
      second: "2-digit",
    });

    const dateFormatter = new Intl.DateTimeFormat(undefined, {
      year: "numeric",
      month: "2-digit",
      day: "2-digit",
      hour: "2-digit",
      minute: "2-digit",
      second: "2-digit",
    });

function formatTime(value) {
  if (!value) {
    return null;
  }
  const date = new Date(value);
  if (Number.isNaN(date.getTime())) {
    return null;
  }
  return `${timeFormatter.format(date)} · ${dateFormatter.format(date)}`;
}

function renderTime(trade) {
  const human = trade.entry_human_time || trade.exit_human_time;
  const iso = formatTime(trade.display_time);
  if (human && iso) {
    return `${human}（${iso}）`;
  }
  return human || iso || "未知时间";
}

    function formatNumber(value, digits = 2) {
      if (value === null || value === undefined || Number.isNaN(value)) {
        return "—";
      }
      const fixed = Number(value);
      if (Number.isNaN(fixed)) {
        return "—";
      }
      if (Math.abs(fixed) >= 1000) {
        return fixed.toLocaleString(undefined, { maximumFractionDigits: digits });
      }
      return fixed.toFixed(digits);
    }

    function createChip(label, value, active, onSelect) {
      const chip = document.createElement("button");
      chip.type = "button";
      chip.className = `filter-chip${active ? " active" : ""}`;
      chip.textContent = label;
      chip.addEventListener("click", () => onSelect(value));
      return chip;
    }

    function renderFilterChips(container, items, activeValue, onSelect) {
      container.innerHTML = "";
      container.appendChild(createChip("全部", "all", activeValue === "all", onSelect));
      items.forEach((value) => {
        const label = value || "未命名";
        container.appendChild(createChip(label, value, activeValue === value, onSelect));
      });
    }

function updateFilters() {
  const models =
    state.availableModels.length > 0
      ? state.availableModels
      : Array.from(new Set(state.trades.map((trade) => trade.model_id).filter(Boolean))).sort();
  const symbols =
    state.availableSymbols.length > 0
      ? state.availableSymbols
      : Array.from(new Set(state.trades.map((trade) => trade.symbol).filter(Boolean))).sort();

      renderFilterChips(modelFiltersEl, models, state.filters.model, (value) => {
        state.filters.model = value;
        renderTrades();
      });

      renderFilterChips(symbolFiltersEl, symbols, state.filters.symbol, (value) => {
        state.filters.symbol = value;
        renderTrades();
      });

      updateSummaries(models, symbols);
    }

    function applyFilters(trades) {
      return trades.filter((trade) => {
        const modelMatch =
          state.filters.model === "all" || trade.model_id === state.filters.model;
        const symbolMatch =
          state.filters.symbol === "all" || trade.symbol === state.filters.symbol;
        return modelMatch && symbolMatch;
      });
    }

    function updateSummaries(models, symbols) {
      const modelLabel =
        state.filters.model === "all"
          ? `模型：全部 (${models.length || 0} 个)`
          : `模型：${state.filters.model}`;
      const symbolLabel =
        state.filters.symbol === "all"
          ? `币种：全部 (${symbols.length || 0} 个)`
          : `币种：${state.filters.symbol}`;

      modelSummaryEl.textContent = modelLabel;
      symbolSummaryEl.textContent = symbolLabel;
    }

    function renderTrades() {
      const filtered = applyFilters(state.trades);
      const openFiltered = filtered.filter((item) => item.status === "open").length;
      feedEl.innerHTML = "";

      if (filtered.length === 0) {
        feedEl.hidden = true;
        emptyStateEl.hidden = false;
        statusTextEl.textContent = "暂无数据";
        return;
      }

      feedEl.hidden = false;
      emptyStateEl.hidden = true;

      filtered.forEach((trade) => {
        const direction = (trade.side || "").toLowerCase();
        const sideLabel = direction === "long" ? "多" : direction === "short" ? "空" : "—";
        const leverageDisplay =
          typeof trade.leverage === "number"
            ? `${formatNumber(trade.leverage, 2)}x`
            : trade.raw_leverage || "—";
        const quantitySigned =
          trade.quantity === null || trade.quantity === undefined
            ? null
            : Number(trade.quantity);
        const quantityAbs = quantitySigned === null ? null : Math.abs(quantitySigned);
        const isOpen = trade.status === "open";
        const statusLabel = isOpen ? "进行中" : "已结束";
        const statusClass = isOpen ? "open" : "closed";
        const priceLabel = isOpen ? "当前价格" : "平仓价格";
        const priceValue = isOpen ? trade.current_price : trade.exit_price;
        const pnlLabel = isOpen ? "未实现盈亏" : "已实现净盈亏";
        const pnlRaw = isOpen ? trade.unrealized_pnl : trade.realized_net_pnl;
        const pnlValue = pnlRaw === null || pnlRaw === undefined ? null : Number(pnlRaw);

        const card = document.createElement("article");
        card.className = "trade-card";
        card.innerHTML = `
          <div class="trade-header">
            <div>
              <span class="trade-time">${renderTime(trade)}</span>
              <span class="trade-status ${statusClass}">${statusLabel}</span>
            </div>
            <span class="trade-side ${direction}">${sideLabel}</span>
          </div>
          <div class="trade-headline">${trade.symbol ?? "未知品种"} · ${trade.model_id ?? "未知模型"}</div>
          <div class="trade-meta">
            <div class="metric">
              <span>杠杆</span>
              <strong>${leverageDisplay}</strong>
            </div>
            <div class="metric">
              <span>数量</span>
              <strong>${formatNumber(quantitySigned, 4)}</strong>
            </div>
            <div class="metric">
              <span>数量绝对值</span>
              <strong>${formatNumber(quantityAbs, 4)}</strong>
            </div>
            <div class="metric">
              <span>开仓价格</span>
              <strong>${formatNumber(trade.entry_price, 4)}</strong>
            </div>
            <div class="metric">
              <span>${priceLabel}</span>
              <strong>${formatNumber(priceValue, 4)}</strong>
            </div>
            <div class="metric">
              <span>止盈价格</span>
              <strong>${formatNumber(trade.profit_target ?? trade.exit_price, 4)}</strong>
            </div>
            <div class="metric">
              <span>止损</span>
              <strong>${formatNumber(trade.stop_loss, 4)}</strong>
            </div>
            <div class="metric">
              <span>${pnlLabel}</span>
              <strong>${formatNumber(pnlValue, 2)}</strong>
            </div>
          </div>
        `;
        feedEl.appendChild(card);
      });

      statusTextEl.textContent = `筛选后 ${filtered.length} 条 · 进行中 ${openFiltered} 条`;
    }

    async function fetchTrades() {
      statusTextEl.textContent = "更新中…";
      try {
        const response = await fetch(API_URL);
        if (!response.ok) {
          throw new Error(`HTTP ${response.status}`);
        }
        const data = await response.json();
        state.trades = Array.isArray(data.trades) ? data.trades : [];
        state.availableModels = Array.isArray(data.models) ? data.models : [];
        state.availableSymbols = Array.isArray(data.symbols) ? data.symbols : [];
        updateFilters();
        renderTrades();
        lastUpdatedEl.textContent = formatTime(data.fetched_at) || data.fetched_at || "—";
        errorStateEl.hidden = true;
      } catch (error) {
        console.error("Failed to fetch trades", error);
        statusTextEl.textContent = "错误";
        errorStateEl.textContent = `获取交易数据失败：${error.message || error}`;
        errorStateEl.hidden = false;
      }
    }

    resetFiltersBtn.addEventListener("click", () => {
      state.filters.model = "all";
      state.filters.symbol = "all";
      updateFilters();
      renderTrades();
    });

    fetchTrades();
    setInterval(fetchTrades, POLL_INTERVAL);
  </script>
</body>
</html>
