<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Alpha Arena 实时交易播报</title>
  <style>
    :root {
      color-scheme: light;
      font-family: "Space Grotesk", "Inter", "HarmonyOS Sans", "PingFang SC", "Microsoft YaHei",
        system-ui, -apple-system, sans-serif;
      background-color: #f7f5f1;
      color: #14110f;
    }

    * {
      box-sizing: border-box;
    }

    body {
      margin: 0;
      min-height: 100vh;
      background: #f8f6f2;
    }

    a {
      color: inherit;
    }

    .page {
      max-width: 1280px;
      margin: 0 auto;
      padding: 1.8rem 1.2rem 3rem;
      display: flex;
      flex-direction: column;
      gap: 1.6rem;
    }

    header.brand-bar {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 1rem;
      padding-bottom: 0.8rem;
      border-bottom: 2px solid #14110f;
    }

    .brand-logo {
      font-size: 1.6rem;
      font-weight: 700;
      letter-spacing: 0.08em;
      text-transform: uppercase;
    }

    .brand-logo span {
      font-weight: 400;
    }

    .brand-nav {
      display: flex;
      gap: 1.2rem;
      font-size: 0.92rem;
      letter-spacing: 0.08em;
      text-transform: uppercase;
    }

    .brand-nav span {
      opacity: 0.65;
    }

    .ticker-bar {
      display: flex;
      flex-wrap: wrap;
      gap: 0.8rem;
      background: #ffffff;
      border: 2px solid #14110f;
      box-shadow: 6px 6px 0 #14110f;
      padding: 0.75rem 1rem;
    }

    .stat-chip {
      display: grid;
      grid-template-columns: auto auto;
      column-gap: 0.4rem;
      row-gap: 0.1rem;
      align-items: baseline;
      padding: 0.35rem 0.8rem;
      background: #f1efe9;
      border: 1px solid #14110f;
      border-radius: 6px;
      font-size: 0.86rem;
      min-width: 160px;
    }

    .stat-chip span {
      font-weight: 600;
      letter-spacing: 0.04em;
    }

    #notification {
      padding: 0.65rem 1rem;
      border-radius: 10px;
      border: 1px solid #14110f;
      background: #fff9d6;
      box-shadow: 4px 4px 0 #14110f;
      font-size: 0.9rem;
      line-height: 1.4;
    }

    #notification strong {
      color: #d9480f;
    }

    #notification[hidden] {
      display: none;
    }

    main.dashboard {
      display: flex;
      flex-direction: column;
      gap: 1.4rem;
    }

    .dashboard-grid {
      display: grid;
      grid-template-columns: 2fr 1fr;
      gap: 1.4rem;
    }

    .card {
      border: 2px solid #14110f;
      background: #ffffff;
      box-shadow: 6px 6px 0 #14110f;
      border-radius: 12px;
      overflow: hidden;
      display: flex;
      flex-direction: column;
    }

    .card h2 {
      margin: 0;
      padding: 0.85rem 1.1rem;
      font-size: 1rem;
      letter-spacing: 0.08em;
      text-transform: uppercase;
      border-bottom: 1px solid #14110f;
      background: #f4f1ea;
    }

    .chart-area {
      flex: 1;
      padding: 1.5rem 1.2rem 1.8rem;
      background: repeating-linear-gradient(
          90deg,
          rgba(20, 17, 15, 0.08),
          rgba(20, 17, 15, 0.08) 1px,
          transparent 1px,
          transparent 32px
        ),
        repeating-linear-gradient(
          0deg,
          rgba(20, 17, 15, 0.08),
          rgba(20, 17, 15, 0.08) 1px,
          transparent 1px,
          transparent 32px
        );
      position: relative;
      border-top: 1px solid rgba(20, 17, 15, 0.14);
    }

    .chart-area canvas {
      width: 100% !important;
      height: 320px !important;
    }

    .chart-empty {
      position: absolute;
      inset: 0;
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
      gap: 0.8rem;
      text-align: center;
      color: #5b554d;
      font-size: 0.92rem;
      background: rgba(247, 245, 241, 0.92);
      backdrop-filter: blur(2px);
    }

    .summary-grid {
      display: flex;
      flex-direction: column;
      gap: 0.85rem;
      padding: 1.1rem;
    }

    .summary-item {
      border-left: 4px solid #14110f;
      padding: 0.2rem 0 0.2rem 0.8rem;
      display: flex;
      flex-direction: column;
      gap: 0.35rem;
    }

    .summary-item header {
      display: flex;
      align-items: baseline;
      justify-content: space-between;
      gap: 0.4rem;
    }

    .summary-item header strong {
      font-size: 0.98rem;
      letter-spacing: 0.05em;
      text-transform: uppercase;
    }

    .summary-stats {
      font-size: 0.82rem;
      color: #4e4940;
      display: flex;
      gap: 1.2rem;
      flex-wrap: wrap;
    }

    .summary-stats span {
      font-weight: 500;
    }

    .summary-stats span strong {
      font-weight: 700;
    }

    .summary-item header .account-value {
      font-size: 0.95rem;
      font-weight: 700;
    }

    .summary-empty {
      font-size: 0.86rem;
      color: #6b645a;
    }

    .filters-panel {
      border: 2px solid #14110f;
      background: #ffffff;
      box-shadow: 6px 6px 0 #14110f;
      border-radius: 12px;
      padding: 0.85rem 1.1rem 1rem;
      display: flex;
      flex-wrap: wrap;
      gap: 1rem;
      align-items: center;
    }

    .filters-panel .group {
      display: flex;
      flex-direction: column;
      gap: 0.55rem;
      min-width: 220px;
    }

    .filters-panel label {
      font-size: 0.8rem;
      text-transform: uppercase;
      letter-spacing: 0.12em;
      color: #504a41;
    }

    .filter-chips {
      display: flex;
      flex-wrap: wrap;
      gap: 0.55rem;
    }

    .filter-chip {
      border: 1px solid #14110f;
      border-radius: 999px;
      padding: 0.35rem 0.9rem;
      font-size: 0.82rem;
      background: #f6f2e9;
      cursor: pointer;
      transition: transform 0.12s ease;
    }

    .filter-chip:hover {
      transform: translateY(-1px);
    }

    .filter-chip.active {
      background: #14110f;
      color: #ffffff;
    }

    .filters-panel button {
      border: 1px solid #14110f;
      background: #ffffff;
      padding: 0.45rem 0.95rem;
      border-radius: 8px;
      font-weight: 600;
      cursor: pointer;
      transition: background 0.12s ease;
    }

    .filters-panel button:hover {
      background: #14110f;
      color: #ffffff;
    }

    .feed-panel {
      border: 2px solid #14110f;
      background: #ffffff;
      box-shadow: 6px 6px 0 #14110f;
      border-radius: 12px;
      display: flex;
      flex-direction: column;
    }

    .feed-header {
      display: flex;
      justify-content: space-between;
      align-items: baseline;
      padding: 0.95rem 1.15rem;
      border-bottom: 1px solid #14110f;
      background: #f4f1ea;
    }

    .feed-header h2 {
      margin: 0;
      font-size: 1rem;
      letter-spacing: 0.08em;
      text-transform: uppercase;
    }

    .feed-meta {
      display: flex;
      gap: 1rem;
      font-size: 0.82rem;
      letter-spacing: 0.05em;
      color: #524c42;
    }

    .feed-list {
      display: flex;
      flex-direction: column;
      gap: 1rem;
      padding: 1.1rem 1.15rem 1.4rem;
    }

    .trade-card {
      border: 1px solid #14110f;
      border-left-width: 8px;
      border-radius: 12px;
      padding: 1rem 1.1rem;
      display: flex;
      flex-direction: column;
      gap: 0.75rem;
      background: #fffdf8;
    }

    .trade-top {
      display: flex;
      justify-content: space-between;
      flex-wrap: wrap;
      gap: 0.6rem;
      font-size: 0.88rem;
      letter-spacing: 0.04em;
    }

    .trade-top strong {
      text-transform: uppercase;
      font-size: 0.92rem;
    }

    .trade-status {
      display: inline-flex;
      align-items: center;
      gap: 0.35rem;
      padding: 0.2rem 0.55rem;
      border-radius: 999px;
      border: 1px solid #14110f;
      font-size: 0.72rem;
      letter-spacing: 0.12em;
      text-transform: uppercase;
    }

    .trade-status.open {
      background: #d4f6e6;
      color: #14583e;
    }

    .trade-status.closed {
      background: #e7e4ff;
      color: #2d2f73;
    }

    .trade-body {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(160px, 1fr));
      gap: 0.8rem;
      font-size: 0.84rem;
    }

    .trade-metric span {
      display: block;
      font-size: 0.72rem;
      text-transform: uppercase;
      letter-spacing: 0.12em;
      color: #615a50;
      margin-bottom: 0.2rem;
    }

    .trade-metric strong {
      font-size: 0.92rem;
    }

    .pnl-positive {
      color: #008444;
    }

    .pnl-negative {
      color: #d92d20;
    }

    .empty-state,
    .error-state {
      border: 1px dashed #14110f;
      background: #fff8e6;
      border-radius: 10px;
      padding: 1.6rem 1rem;
      margin: 0 1.2rem 1.2rem;
      text-align: center;
      color: #5c564d;
      font-size: 0.9rem;
    }

    footer {
      text-align: center;
      font-size: 0.78rem;
      color: #6c665d;
      letter-spacing: 0.04em;
    }

    footer span {
      display: block;
      margin-top: 0.2rem;
    }

    @media (max-width: 960px) {
      .dashboard-grid {
        grid-template-columns: 1fr;
      }
    }

    @media (max-width: 640px) {
      .page {
        padding: 1.4rem 0.8rem 2.4rem;
      }

      header.brand-bar {
        flex-direction: column;
        align-items: flex-start;
      }

      .brand-nav {
        flex-wrap: wrap;
        gap: 0.6rem;
      }

      .filters-panel {
        flex-direction: column;
        align-items: stretch;
      }
    }
  </style>
</head>
<body>
  <div class="page">
    <header class="brand-bar">
      <div class="brand-logo">Alpha Arena <span>实时播报</span></div>
      <nav class="brand-nav">
        <span>Live</span>
        <span>Leaderboard</span>
        <span>Models</span>
        <span>Prompts</span>
      </nav>
    </header>

    <section id="stats-bar" class="ticker-bar"></section>
    <div id="notification" hidden></div>

    <main class="dashboard">
      <section class="dashboard-grid">
        <article class="card">
          <h2>总账户价值趋势</h2>
          <div class="chart-area">
            <canvas id="account-chart"></canvas>
            <div id="chart-empty" class="chart-empty">暂无账户数据，等待最新快照…</div>
          </div>
        </article>
        <article class="card">
          <h2>模型概览</h2>
          <div id="summary-grid" class="summary-grid">
            <div class="summary-empty">暂无数据，等待最新交易载入…</div>
          </div>
        </article>
      </section>

      <section class="filters-panel">
        <div class="group">
          <label>模型筛选</label>
          <div class="filter-chips" id="model-filters"></div>
        </div>
        <div class="group">
          <label>币种筛选</label>
          <div class="filter-chips" id="symbol-filters"></div>
        </div>
        <button id="filter-reset" type="button">重置筛选</button>
      </section>

      <section class="feed-panel">
        <div class="feed-header">
          <h2>实时交易播报</h2>
          <div class="feed-meta">
            <span id="status-text">准备中…</span>
            <span id="last-updated">—</span>
          </div>
        </div>

        <div id="feed" class="feed-list"></div>
        <div id="empty-state" class="empty-state" hidden>暂无交易数据，请稍候…</div>
        <div id="error-state" class="error-state" hidden>获取交易数据失败，请稍后重试。</div>
      </section>
    </main>

    <footer>
      数据来源于 NOF1 公共 API · 页面每 30 秒自动刷新
      <span>进行中条目展示未实现盈亏，已结束条目展示已实现盈亏；数量保留符号与绝对值。</span>
    </footer>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script>
    const API_URL = "/api/latest_trades";
    const POLL_INTERVAL = 30_000;

    const statsBarEl = document.getElementById("stats-bar");
    const notificationEl = document.getElementById("notification");
    const feedEl = document.getElementById("feed");
    const emptyStateEl = document.getElementById("empty-state");
    const errorStateEl = document.getElementById("error-state");
    const lastUpdatedEl = document.getElementById("last-updated");
    const statusTextEl = document.getElementById("status-text");
    const modelFiltersEl = document.getElementById("model-filters");
    const symbolFiltersEl = document.getElementById("symbol-filters");
    const resetFiltersBtn = document.getElementById("filter-reset");
    const modelSummaryEl = document.getElementById("model-summary");
    const symbolSummaryEl = document.getElementById("symbol-summary");
    const summaryGridEl = document.getElementById("summary-grid");
    const chartCanvas = document.getElementById("account-chart");
    const chartEmptyEl = document.getElementById("chart-empty");

    let notificationTimer;
    let accountChart;

    const state = {
      trades: [],
      filters: {
        model: "all",
        symbol: "all",
      },
      availableModels: [],
      availableSymbols: [],
      accounts: [],
      seenEvents: new Set(),
      isInitialized: false,
      lastSummary: {
        count: 0,
        open: 0,
        closed: 0,
      },
    };

    const MODEL_COLORS = {
      "gpt-5": "#0f62fe",
      "grok-4": "#ff6f00",
      "qwen3-max": "#6c2bd9",
      "claude-sonnet": "#ff9b6a",
      "gemini-2.5-pro": "#0070f3",
      "gemini-2.5": "#0070f3",
      "deepseek-chat": "#2d8d52",
      "claude": "#ff9b6a",
    };

    function hashColor(value) {
      let hash = 0;
      for (let i = 0; i < value.length; i += 1) {
        hash = value.charCodeAt(i) + ((hash << 5) - hash);
      }
      const hue = Math.abs(hash) % 360;
      return `hsl(${hue}, 65%, 50%)`;
    }

    function colorForModel(model) {
      if (!model) return "#14110f";
      return MODEL_COLORS[model] || hashColor(model);
    }

    const timeFormatter = new Intl.DateTimeFormat(undefined, {
      hour: "2-digit",
      minute: "2-digit",
      second: "2-digit",
    });

    const dateFormatter = new Intl.DateTimeFormat(undefined, {
      year: "numeric",
      month: "2-digit",
      day: "2-digit",
      hour: "2-digit",
      minute: "2-digit",
      second: "2-digit",
    });

    const currencyFormatter = new Intl.NumberFormat(undefined, {
      style: "currency",
      currency: "USD",
      maximumFractionDigits: 2,
    });

    function formatTime(value) {
      if (!value) {
        return null;
      }
      const date = new Date(value);
      if (Number.isNaN(date.getTime())) {
        return null;
      }
      return `${timeFormatter.format(date)} · ${dateFormatter.format(date)}`;
    }

    function renderTime(trade) {
      const human = trade.entry_human_time || trade.exit_human_time;
      const iso = formatTime(trade.display_time);
      if (human && iso) {
        return `${human}（${iso}）`;
      }
      return human || iso || "未知时间";
    }

    function formatNumber(value, digits = 2) {
      if (value === null || value === undefined || Number.isNaN(value)) {
        return "—";
      }
      const fixed = Number(value);
      if (Number.isNaN(fixed)) {
        return "—";
      }
      if (Math.abs(fixed) >= 1000) {
        return fixed.toLocaleString(undefined, { maximumFractionDigits: digits });
      }
      return fixed.toFixed(digits);
    }

    function formatPercent(value) {
      if (value === null || value === undefined || Number.isNaN(value)) {
        return "—";
      }
      const numeric = Number(value);
      if (Number.isNaN(numeric)) {
        return "—";
      }
      return `${formatNumber(numeric, 2)}%`;
    }

    function createChip(label, value, active, onSelect) {
      const chip = document.createElement("button");
      chip.type = "button";
      chip.className = `filter-chip${active ? " active" : ""}`;
      chip.textContent = label;
      chip.addEventListener("click", () => onSelect(value));
      return chip;
    }

    function renderFilterChips(container, items, activeValue, onSelect) {
      container.innerHTML = "";
      container.appendChild(createChip("全部", "all", activeValue === "all", onSelect));
      items.forEach((value) => {
        const label = value || "未命名";
        container.appendChild(createChip(label, value, activeValue === value, onSelect));
      });
    }

    function updateFilters() {
      const models =
        state.availableModels.length > 0
          ? state.availableModels
          : Array.from(new Set(state.trades.map((trade) => trade.model_id).filter(Boolean))).sort();
      const symbols =
        state.availableSymbols.length > 0
          ? state.availableSymbols
          : Array.from(new Set(state.trades.map((trade) => trade.symbol).filter(Boolean))).sort();

      renderFilterChips(modelFiltersEl, models, state.filters.model, (value) => {
        state.filters.model = value;
        renderTrades();
      });

      renderFilterChips(symbolFiltersEl, symbols, state.filters.symbol, (value) => {
        state.filters.symbol = value;
        renderTrades();
      });

      updateSummaries(models, symbols);
    }

    function applyFilters(trades) {
      return trades.filter((trade) => {
        const modelMatch =
          state.filters.model === "all" || trade.model_id === state.filters.model;
        const symbolMatch =
          state.filters.symbol === "all" || trade.symbol === state.filters.symbol;
        return modelMatch && symbolMatch;
      });
    }

    function updateSummaries(models, symbols) {
      const modelLabel =
        state.filters.model === "all"
          ? `模型：全部 (${models.length || 0} 个)`
          : `模型：${state.filters.model}`;
      const symbolLabel =
        state.filters.symbol === "all"
          ? `币种：全部 (${symbols.length || 0} 个)`
          : `币种：${state.filters.symbol}`;

      if (modelSummaryEl) modelSummaryEl.textContent = modelLabel;
      if (symbolSummaryEl) symbolSummaryEl.textContent = symbolLabel;
    }

    function describeSide(side) {
      const lower = (side || "").toLowerCase();
      if (lower === "long") return "多";
      if (lower === "short") return "空";
      return "";
    }

    function describeAlert(trade) {
      const model = trade.model_id || "未知模型";
      const symbol = trade.symbol || "未知品种";
      const side = describeSide(trade.side);
      const action = trade.status === "open" ? "开仓" : "平仓";
      const sideLabel = side ? `（${side}）` : "";
      return `${model} ${action} ${symbol}${sideLabel}`;
    }

    function showNotification(messages) {
      if (!messages.length) {
        return;
      }
      notificationEl.innerHTML = messages
        .map((msg) => `<div><strong>提醒：</strong>${msg}</div>`)
        .join("");
      notificationEl.hidden = false;
      if (notificationTimer) {
        clearTimeout(notificationTimer);
      }
      notificationTimer = setTimeout(() => {
        notificationEl.hidden = true;
        notificationEl.innerHTML = "";
      }, 8000);
    }

    function processNotifications(trades) {
      if (!Array.isArray(trades) || trades.length === 0) {
        return;
      }
      if (!state.isInitialized) {
        trades.forEach((trade) => {
          if (!trade.id) return;
          const key = `${trade.id}|${trade.status}`;
          state.seenEvents.add(key);
        });
        state.isInitialized = true;
        return;
      }

      const newMessages = [];
      trades.forEach((trade) => {
        if (!trade.id) {
          return;
        }
        const key = `${trade.id}|${trade.status}`;
        if (state.seenEvents.has(key)) {
          return;
        }
        state.seenEvents.add(key);
        if (trade.status === "open" || trade.status === "closed") {
          newMessages.push(describeAlert(trade));
        }
      });

      if (newMessages.length) {
        showNotification(newMessages);
      }
    }

    function renderStatsBar() {
      const stats = state.lastSummary;
      const total = stats.count || state.trades.length;
      const open = stats.open ?? state.trades.filter((item) => item.status === "open").length;
      const closed =
        stats.closed ?? state.trades.filter((item) => item.status !== "open").length;

      const accounts = state.accounts || [];
      let totalEquity = 0;
      let topAccount = null;
      accounts.forEach((account) => {
        const value = Number(account.account_value);
        if (!Number.isNaN(value)) {
          totalEquity += value;
          if (!topAccount || value > (topAccount.account_value ?? -Infinity)) {
            topAccount = { ...account, account_value: value };
          }
        }
      });

      const totalEquityText =
        accounts.length > 0 && Number.isFinite(totalEquity)
          ? currencyFormatter.format(totalEquity)
          : "—";
      let topModelText = "—";
      if (topAccount) {
        const topValueText =
          topAccount.account_value !== null && topAccount.account_value !== undefined
            ? currencyFormatter.format(topAccount.account_value)
            : "—";
        const topReturnValue =
          topAccount.total_return_pct !== null && topAccount.total_return_pct !== undefined
            ? Number(topAccount.total_return_pct)
            : null;
        const topReturnText =
          topReturnValue !== null && !Number.isNaN(topReturnValue)
            ? formatPercent(topReturnValue)
            : "—";
        topModelText = `${topAccount.model_id} · ${topValueText}${
          topReturnText !== "—" ? ` (${topReturnText})` : ""
        }`;
      }

      statsBarEl.innerHTML = `
        <div class="stat-chip">
          <span>总记录</span>
          <div>${total}</div>
        </div>
        <div class="stat-chip">
          <span>进行中</span>
          <div>${open}</div>
        </div>
        <div class="stat-chip">
          <span>已结束</span>
          <div>${closed}</div>
        </div>
        <div class="stat-chip">
          <span>资产合计</span>
          <div>${totalEquityText}</div>
        </div>
        <div class="stat-chip">
          <span>最高账户</span>
          <div>${topModelText}</div>
        </div>
      `;
    }

    function buildModelStats(trades, accounts) {
      const map = new Map();
      trades.forEach((trade) => {
        const model = trade.model_id || "未知模型";
        const entry =
          map.get(model) || { model, open: 0, closed: 0, pnl: 0, accountValue: null, returnPct: null };
        if (trade.status === "open") {
          entry.open += 1;
        } else {
          entry.closed += 1;
        }
        const pnlCandidate =
          trade.status === "open" ? trade.unrealized_pnl : trade.realized_net_pnl;
        const pnl = Number(pnlCandidate);
        if (!Number.isNaN(pnl)) {
          entry.pnl += pnl;
        }
        map.set(model, entry);
      });
      accounts.forEach((account) => {
        const model = account.model_id || "未知模型";
        const entry =
          map.get(model) || { model, open: 0, closed: 0, pnl: 0, accountValue: null, returnPct: null };
        const value = Number(account.account_value);
        if (!Number.isNaN(value)) {
          entry.accountValue = value;
        }
        const returnPctRaw = Number(account.total_return_pct);
        if (!Number.isNaN(returnPctRaw)) {
          const normalizedPct = Math.abs(returnPctRaw) <= 1 ? returnPctRaw * 100 : returnPctRaw;
          entry.returnPct = normalizedPct;
        }
        const unrealized = Number(account.total_unrealized_pnl);
        if (!Number.isNaN(unrealized)) {
          entry.pnl += unrealized;
        }
        map.set(model, entry);
      });

      return Array.from(map.values()).sort((a, b) => {
        const aValue = a.accountValue;
        const bValue = b.accountValue;
        if (aValue !== undefined || bValue !== undefined) {
          const safeA = aValue !== null && aValue !== undefined ? aValue : -Number.MAX_VALUE;
          const safeB = bValue !== null && bValue !== undefined ? bValue : -Number.MAX_VALUE;
          if (safeA !== safeB) {
            return safeB - safeA;
          }
        }
        const aReturn = a.returnPct;
        const bReturn = b.returnPct;
        if (aReturn !== undefined || bReturn !== undefined) {
          const safeA = aReturn !== null && aReturn !== undefined ? aReturn : -Number.MAX_VALUE;
          const safeB = bReturn !== null && bReturn !== undefined ? bReturn : -Number.MAX_VALUE;
          if (safeA !== safeB) {
            return safeB - safeA;
          }
        }
        const pnlDiff = (b.pnl ?? 0) - (a.pnl ?? 0);
        if (Math.abs(pnlDiff) > 1e-9) {
          return pnlDiff;
        }
        return b.open - a.open || b.closed - a.closed;
      });
    }

    function renderSummary() {
      const stats = buildModelStats(state.trades, state.accounts);
      summaryGridEl.innerHTML = "";
      if (!stats.length) {
        summaryGridEl.innerHTML =
          '<div class="summary-empty">暂无数据，等待最新交易载入…</div>';
        return;
      }

      stats.slice(0, 6).forEach((item) => {
        const color = colorForModel(item.model);
        const accountValueText =
          item.accountValue !== null && item.accountValue !== undefined
            ? currencyFormatter.format(item.accountValue)
            : "—";
        const returnValue =
          item.returnPct !== null && item.returnPct !== undefined
            ? Number(item.returnPct)
            : null;
        const hasReturn = returnValue !== null && !Number.isNaN(returnValue);
        const returnClass = hasReturn
          ? returnValue >= 0
            ? "pnl-positive"
            : "pnl-negative"
          : "";
        const returnText = hasReturn ? formatPercent(returnValue) : "—";
        const pnlValue = Number(item.pnl);
        const pnlClass =
          Number.isNaN(pnlValue) || pnlValue === 0
            ? ""
            : pnlValue >= 0
            ? "pnl-positive"
            : "pnl-negative";
        const pnlText = Number.isNaN(pnlValue) ? "—" : currencyFormatter.format(pnlValue);

        summaryGridEl.innerHTML += `
          <article class="summary-item" style="border-color:${color}">
            <header>
              <strong>${item.model}</strong>
              <span class="account-value">${accountValueText}</span>
            </header>
            <div class="summary-stats">
              <span>收益率：<strong class="${returnClass}">${returnText}</strong></span>
              <span>累计盈亏：<strong class="${pnlClass}">${pnlText}</strong></span>
              <span>进行中：<strong>${item.open}</strong></span>
              <span>已结束：<strong>${item.closed}</strong></span>
            </div>
          </article>
        `;
      });
    }

    function updateChart(accounts) {
      if (!window.Chart || !chartCanvas) {
        return;
      }

      const context = chartCanvas.getContext("2d");
      const sorted = [...(accounts || [])]
        .filter((account) => Number.isFinite(Number(account.account_value)))
        .sort((a, b) => Number(b.account_value) - Number(a.account_value))
        .slice(0, 10);

      if (chartEmptyEl) {
        chartEmptyEl.hidden = sorted.length > 0;
      }

      if (!sorted.length) {
        if (accountChart) {
          accountChart.destroy();
          accountChart = null;
        }
        return;
      }

      const labels = sorted.map((account) => account.model_id || "未知模型");
      const data = sorted.map((account) => Number(account.account_value));
      const backgrounds = labels.map((label) => colorForModel(label));

      if (!accountChart) {
        accountChart = new Chart(context, {
          type: "bar",
          data: {
            labels,
            datasets: [
              {
                label: "账户资产（USD）",
                data,
                backgroundColor: backgrounds,
                borderColor: "#14110f",
                borderWidth: 1.2,
              },
            ],
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
              legend: { display: false },
              tooltip: {
                callbacks: {
                  label: (ctx) =>
                    `${ctx.dataset.label}: ${currencyFormatter.format(ctx.parsed.y)}`,
                },
              },
            },
            scales: {
              x: {
                ticks: {
                  font: { weight: "600" },
                },
                grid: { display: false },
              },
              y: {
                ticks: {
                  callback: (value) => currencyFormatter.format(value),
                },
                grid: { color: "rgba(20,17,15,0.1)" },
              },
            },
          },
        });
      } else {
        accountChart.data.labels = labels;
        accountChart.data.datasets[0].data = data;
        accountChart.data.datasets[0].backgroundColor = backgrounds;
        accountChart.update();
      }
    }

    function renderTrades() {
      const filtered = applyFilters(state.trades);
      const openFiltered = filtered.filter((item) => item.status === "open").length;
      feedEl.innerHTML = "";

      if (filtered.length === 0) {
        feedEl.hidden = true;
        emptyStateEl.hidden = false;
        statusTextEl.textContent = "暂无数据";
        return;
      }

      feedEl.hidden = false;
      emptyStateEl.hidden = true;

      filtered.forEach((trade) => {
        const direction = (trade.side || "").toLowerCase();
        const sideLabel = direction === "long" ? "多" : direction === "short" ? "空" : "—";
        const leverageDisplay =
          typeof trade.leverage === "number"
            ? `${formatNumber(trade.leverage, 2)}x`
            : trade.raw_leverage || "—";
        const quantitySigned =
          trade.quantity === null || trade.quantity === undefined
            ? null
            : Number(trade.quantity);
        const quantityAbs = quantitySigned === null ? null : Math.abs(quantitySigned);
        const isOpen = trade.status === "open";
        const statusLabel = isOpen ? "进行中" : "已结束";
        const statusClass = isOpen ? "open" : "closed";
        const priceLabel = isOpen ? "当前价格" : "平仓价格";
        const priceValue = isOpen ? trade.current_price : trade.exit_price;
        const pnlLabel = isOpen ? "未实现盈亏" : "已实现净盈亏";
        const pnlRaw = isOpen ? trade.unrealized_pnl : trade.realized_net_pnl;
        const pnlValue = pnlRaw === null || pnlRaw === undefined ? null : Number(pnlRaw);
        const pnlClass =
          pnlValue === null ? "" : pnlValue >= 0 ? "pnl-positive" : "pnl-negative";
        const modelColor = colorForModel(trade.model_id);

        const card = document.createElement("article");
        card.className = "trade-card";
        card.style.borderLeftColor = modelColor;
        card.innerHTML = `
          <div class="trade-top">
            <div>
              <strong>${trade.model_id ?? "未知模型"}</strong>
              <span> · ${trade.symbol ?? "未知品种"}</span>
            </div>
            <div>
              <span class="trade-status ${statusClass}">${statusLabel}</span>
            </div>
          </div>
          <div class="trade-top">
            <div>${renderTime(trade)}</div>
            <div>方向：${sideLabel}</div>
          </div>
          <div class="trade-body">
            <div class="trade-metric">
              <span>杠杆</span>
              <strong>${leverageDisplay}</strong>
            </div>
            <div class="trade-metric">
              <span>数量</span>
              <strong>${formatNumber(quantitySigned, 4)}</strong>
            </div>
            <div class="trade-metric">
              <span>数量绝对值</span>
              <strong>${formatNumber(quantityAbs, 4)}</strong>
            </div>
            <div class="trade-metric">
              <span>开仓价格</span>
              <strong>${formatNumber(trade.entry_price, 4)}</strong>
            </div>
            <div class="trade-metric">
              <span>${priceLabel}</span>
              <strong>${formatNumber(priceValue, 4)}</strong>
            </div>
            <div class="trade-metric">
              <span>止盈价格</span>
              <strong>${formatNumber(trade.profit_target ?? trade.exit_price, 4)}</strong>
            </div>
            <div class="trade-metric">
              <span>止损</span>
              <strong>${formatNumber(trade.stop_loss, 4)}</strong>
            </div>
            <div class="trade-metric">
              <span>${pnlLabel}</span>
              <strong class="${pnlClass}">${formatNumber(pnlValue, 2)}</strong>
            </div>
          </div>
        `;
        feedEl.appendChild(card);
      });

      const totalCount = state.lastSummary.count || state.trades.length;
      const totalOpen = state.lastSummary.open ?? state.trades.filter((item) => item.status === "open").length;
      statusTextEl.textContent = `筛选后 ${filtered.length} 条 · 进行中 ${openFiltered} 条 · 总计 ${totalCount} 条（实时持仓 ${totalOpen} 条）`;
    }

    async function fetchTrades() {
      statusTextEl.textContent = "更新中…";
      try {
        const response = await fetch(API_URL);
        if (!response.ok) {
          throw new Error(`HTTP ${response.status}`);
        }

        const data = await response.json();
        const trades = Array.isArray(data.trades) ? data.trades : [];
        const accounts = Array.isArray(data.accounts) ? data.accounts : [];
        state.trades = trades;
        state.accounts = accounts;
        state.availableModels = Array.isArray(data.models) ? data.models : [];
        state.availableSymbols = Array.isArray(data.symbols) ? data.symbols : [];
        const totalCount = Number(data.count);
        const openCount = Number(data.open_count);
        const closedCount = Number(data.closed_count);
        state.lastSummary = {
          count: Number.isFinite(totalCount) ? totalCount : trades.length,
          open: Number.isFinite(openCount)
            ? openCount
            : trades.filter((item) => item.status === "open").length,
          closed: Number.isFinite(closedCount)
            ? closedCount
            : trades.filter((item) => item.status !== "open").length,
        };

        processNotifications(trades);
        renderStatsBar();
        renderSummary();
        updateChart(state.accounts);
        updateFilters();
        renderTrades();
        lastUpdatedEl.textContent = formatTime(data.fetched_at) || data.fetched_at || "—";
        errorStateEl.hidden = true;
      } catch (error) {
        console.error("Failed to fetch trades", error);
        statusTextEl.textContent = "错误";
        errorStateEl.textContent = `获取交易数据失败：${error.message || error}`;
        errorStateEl.hidden = false;
      }
    }

    resetFiltersBtn.addEventListener("click", () => {
      state.filters.model = "all";
      state.filters.symbol = "all";
      updateFilters();
      renderTrades();
    });

    renderStatsBar();
    renderSummary();
    updateFilters();
    renderTrades();
    updateChart(state.accounts);

    fetchTrades();
    setInterval(fetchTrades, POLL_INTERVAL);
  </script>
</body>
</html>
